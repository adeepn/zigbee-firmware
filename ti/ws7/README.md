# Прошивки для трехканального модуля дискретных входов WS7

Описание устройства: https://jethome.ru/wiki/jethome-ws7-trehkanalnyy-modul-diskretnyh-vhodov-zigbee/

## Структура репозитария

  * client - директория с прошивками, поставляемых с устройством;
  * ota - прошивки, подготовленные для обновления устройства с помощью механизма OTA.

## Версии прошивок
  
  * ws7_20210922_f123_f001_00000008 - базовая прошивка
  * ws7_20220630_f123_f001_00000009 - добавлен прямой биндинг устройства (кластер on/off), добавлена поддержка групп
  * ws7_20230627_f123_f001_0000000a - отключен "Insecure Rejoin" (решение проблемы с самопроизвольным выходом из сети). Снижено энергопотребление.   
  
## Инструкция по обновлению устройства с помощью механизма OTA

Устройства JetHome WS7 поддерживают механизм обновления OTA, однако в текущей стабильной версии Zigbee2MQTT (1.25.2) данный механизм не включен для устройств JetHome WS7. Ниже приводится инструкция по обновлению устройства JetHome WS7 с спользованием механизма OTA. Механизм проверен на следующей конфигурации:

Zigbee2MQTT version: 1.32.1  
Coordinator type: zStack3x0  
Coordinator revision: 20220524  
Frontend version: 0.6.129

1. В директории, в которую установлен Zigbee2MQTT отредактируйте файл `zigbee2mqtt/node_modules/zigbee-herdsman-converters/devices/jethome.js` (https://github.com/Koenkk/zigbee-herdsman-converters/blob/master/devices/jethome.js):

    * Подключить библиотеку OTA: `const ota = require('../lib/ota');`
    * В описании устройства WS7 включить поддержку OTA: `ota: ota.zigbeeOTA,`
   
   В файл [jethome.js](https://github.com/jethome-ru/zigbee-firmware/blob/master/ti/ws7/jethome.js), расположенный в корне проекта WS7, внесены необходимые исправления. 

2. Перезапустите службу zigbee2mqtt.

3. Откройте WEB-интерфейс (frontend) Zigbee2MQTT и перейдите в раздел: `Settings/OTA updates` 
  В поле `OTA index override file name` укажите ссылку на новый файл с описанием OTA прошивок для устройств JetHome: `https://github.com/jethome-ru/zigbee-firmware/raw/master/ti/ws7/jethome_ota_index.json`  
  Нажмите кнопку ***'Submit'***.

4. Перейдите в раздел `OTA`. Нажмите кнопку ***'Check for new update'*** напротив устройства JetHome WS7. На обновляемом устройстве Jethome WS7 нажмите кнопку переключения режимов (кнопка на корпусе устройства). Подождите появления кнопки ***'Update device firmware'*** в WEB-интерфейсе Zigbee2MQTT. Нажмите на нее. 

5. Так как устройство JetHome WS7 большую часть времени находится в спящем режиме, то на нем необходимо с периодом ~2 сек нажать 3-4 раза на кнопку переключения режимов. Начнется процесс обновления. Время обновления может достигать до 80 минут. 

После обновления прошивки устройства до версии ws7_20220630_f123_f001_00000009 его необходимо переподключить к координатору, так как в данной прошивке были добавлены новые кластеры для обеспечения работы прямого биндинга устройства.

Настройка биндинга устройства может быть произведена в Web-интерфейсе (frontend) Zigbee2MQTT. Документация на сайте Zigbee2MQTT^ https://www.zigbee2mqtt.io/guide/usage/binding.html
